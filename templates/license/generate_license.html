<!DOCTYPE html>
<html>
<head>
  <title>Generate License</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-5">
  <div class="card shadow">
    <div class="card-header bg-dark text-white">
      Generate License Key
    </div>

    <div class="card-body">
      <form method="post">
        {% csrf_token %}

        <div class="mb-3">
          <label class="form-label">Machine ID</label>
          <input id="machine_id" name="machine_id" class="form-control" required>
        </div>

        <div class="mb-3">
          <label class="form-label">Expiry Date</label>
          <input type="date" name="expiry" class="form-control" required>
        </div>

        <button class="btn btn-primary w-100">Generate License</button>
      </form>

      {% if license_key %}
        <hr>
        <label class="form-label">Generated License Key</label>
        <textarea class="form-control" rows="3" readonly>{{ license_key }}</textarea>
      {% endif %}
    </div>

    <div class="card-footer text-center">
      <a href="/license/activate/" class="btn btn-outline-secondary">
        Go to Activate License
      </a>
    </div>
  </div>

</div>
<script>
document.addEventListener("DOMContentLoaded", () => {
    fetch("/license/activate/machine-id/")
        .then(res => res.json())
        .then(data => {
            console.log("Fetched Machine ID:", data.machine_id);
            const input = document.getElementById("machine_id");
            if(input) {  // ensure input exists
                input.value = data.machine_id;
            } else {
                console.error("Input not found!");
            }
        });
});
</script>


    <script>
        const form = document.getElementById('licenseForm');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const machine_id = document.getElementById('machine_id').value;
            const expiry = document.getElementById('expiry').value;

            // Clear previous results
            document.getElementById('result').textContent = '';
            document.getElementById('error').textContent = '';

            try {
                const response = await fetch("{% url 'generate_license' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                        "X-CSRFToken": "{{ csrf_token }}"
                    },
                    body: `machine_id=${encodeURIComponent(machine_id)}&expiry=${encodeURIComponent(expiry)}`
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById('result').textContent = `License Key: ${data.license_key}`;
                } else {
                    document.getElementById('error').textContent = data.error || "An error occurred";
                }
            } catch (err) {
                document.getElementById('error').textContent = err.message;
            }
        });
    </script>

</body>
</html>
